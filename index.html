<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventory & Maintenance Demo</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; max-width:700px; margin:2rem auto; }
    h1 { margin-bottom: .5rem; }
    #messages { border:1px solid #ddd; padding:1rem; min-height:200px; max-height:400px; overflow-y:auto; margin-top:.5rem; }
    .msg { padding:6px 4px; border-bottom:1px solid #f0f0f0; }
    form { margin-top:1rem; display:flex; gap:.5rem; }
    input, select { padding:.6rem; font-size:1rem; }
    input { flex:1; }
    button { padding:.6rem 1rem; }
  </style>
</head>
<body>
  <h1>Inventory & Maintenance</h1>
  <p>Select lab & equipment, type maintenance note — updates in real-time.</p>

  <div>
    <label for="labSelect">Lab: </label>
    <select id="labSelect"></select>

    <label for="eqSelect">Equipment: </label>
    <select id="eqSelect"></select>
  </div>

  <div id="messages" aria-live="polite"></div>

  <form id="msgForm">
    <input id="msgInput" placeholder="Write maintenance note..." required autocomplete="off"/>
    <button type="submit">Send</button>
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB2vduLYT5w_SVMHo6KJ0CVJWWexICip_4",
      authDomain: "my-realtime-site.firebaseapp.com",
      projectId: "my-realtime-site",
      storageBucket: "my-realtime-site.appspot.com",
      messagingSenderId: "824570401818",
      appId: "1:824570401818:web:917f7ec3bc0067c971ada3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const labSelect = document.getElementById('labSelect');
    const eqSelect = document.getElementById('eqSelect');
    const messagesEl = document.getElementById('messages');
    const form = document.getElementById('msgForm');
    const input = document.getElementById('msgInput');

    const staffId = "staff1"; // example staff

    let unsubscribe = null;

    // --- Load labs and equipment ---
    async function loadLabs() {
      const labsSnapshot = await getDocs(collection(db,"labs"));
      labSelect.innerHTML = "";
      labsSnapshot.forEach(doc => {
        const lab = doc.data();
        const option = document.createElement("option");
        option.value = doc.id;
        option.textContent = lab.name;
        labSelect.appendChild(option);
      });
      await loadEquipment(labSelect.value);
    }

    async function loadEquipment(labId) {
      const eqSnapshot = await getDocs(collection(db,"labs",labId,"equipment"));
      eqSelect.innerHTML = "";
      eqSnapshot.forEach(doc => {
        const eq = doc.data();
        const option = document.createElement("option");
        option.value = doc.id;
        option.textContent = eq.name;
        eqSelect.appendChild(option);
      });
      listenLogs(labId, eqSelect.value);
    }

    // --- Listen to logs for selected equipment ---
    function listenLogs(labId, eqId) {
      if (unsubscribe) unsubscribe();
      const logsCol = collection(db,"labs",labId,"equipment",eqId,"maintenance_logs");
      unsubscribe = onSnapshot(logsCol, snapshot => {
        messagesEl.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "msg";
          div.textContent = `${new Date(data.date.seconds*1000).toLocaleTimeString()} — ${data.notes}`;
          messagesEl.appendChild(div);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    // --- Event listeners ---
    labSelect.addEventListener('change', e => loadEquipment(e.target.value));
    eqSelect.addEventListener('change', e => listenLogs(labSelect.value, e.target.value));

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const note = input.value.trim();
      if (!note) return;

      const labId = labSelect.value;
      const eqId = eqSelect.value;

      const logCol = collection(db,"labs",labId,"equipment",eqId,"maintenance_logs");
      await addDoc(logCol,{
        staff: staffId,
        notes: note,
        date: new Date()
      });

      await updateDoc(doc(db,"labs",labId,"equipment",eqId), { last_maintenance: new Date() });
      input.value = '';
    });

    // --- Optional: create sample data if needed ---
    async function createSampleData() {
      const labs = [
        {id:"lab1", name:"Lab Kimia", eqs:[{id:"eq1", name:"Microscope", quantity:5, status:"Good"},{id:"eq2", name:"Centrifuge", quantity:2, status:"Needs Repair"}]},
        {id:"lab2", name:"Lab Fizik", eqs:[{id:"eq1", name:"Oscilloscope", quantity:3, status:"Good"}]},
        {id:"lab3", name:"Lab Biologi", eqs:[{id:"eq1", name:"Incubator", quantity:2, status:"Good"},{id:"eq2", name:"Autoclave", quantity:1, status:"Needs Repair"}]}
      ];

      for (const lab of labs) {
        await setDoc(doc(db,"labs",lab.id), {name:lab.name});
        for(const eq of lab.eqs){
          await setDoc(doc(db,"labs",lab.id,"equipment",eq.id),{
            name: eq.name,
            quantity: eq.quantity,
            status: eq.status,
            last_maintenance: new Date()
          });
        }
      }
    }

    // Uncomment below line to create sample data once
    // createSampleData();

    // Load labs & equipment on page load
    loadLabs();

  </script>
</body>
</html>

